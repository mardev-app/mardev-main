<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OAuth Callback - mardev.app</title>
  <style>
    body {
      background: #222;
      color: white;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 1rem;
    }
    .callback-message {
      background: #333;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    .callback-message h3 {
      margin: 0;
      font-weight: 600;
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <div id="message" class="callback-message">
    <h3>⏳ Processing authentication...</h3>
  </div>

  <script>
    // Utility to set cookie
    function setCookie(name, value, days = 30) {
      const expires = new Date();
      expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;secure;samesite=strict`;
    }

    // Utility to remove cookie
    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
    }

    async function exchangeCodeForToken(code) {
      try {
        const response = await fetch('https://auth.mardev.app/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            client_id: 'mardev-app-client',
            code: code,
            redirect_uri: 'https://mardev.app/auth/callback'
          })
        });
        if (!response.ok) {
          throw new Error(`Token exchange failed: ${response.status}`);
        }
        return await response.json();
      } catch (err) {
        console.error(err);
        throw err;
      }
    }

    function showMessage(message, type = 'loading') {
      const el = document.getElementById('message');
      let emoji = '⏳';
      if (type === 'success') emoji = '✅';
      if (type === 'error') emoji = '❌';
      el.innerHTML = `<h3>${emoji} ${message}</h3>`;
    }

    async function handleCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');
      const error_description = params.get('error_description');

      if (error) {
        showMessage(`Authentication failed: ${error_description || error}`, 'error');
        setTimeout(() => {
          window.location.href = '/'; // redirect back to homepage or login page
        }, 4000);
        return;
      }

      if (!code) {
        showMessage('No authorization code found', 'error');
        setTimeout(() => {
          window.location.href = '/';
        }, 4000);
        return;
      }

      showMessage('Exchanging authorization code for token...', 'loading');

      try {
        const tokenData = await exchangeCodeForToken(code);

        setCookie('mardev_auth', tokenData.access_token, 30);
        if (tokenData.refresh_token) {
          setCookie('mardev_refresh', tokenData.refresh_token, 90);
        }

        showMessage('Authentication successful!', 'success');

        // Clean URL by removing query params
        window.history.replaceState({}, document.title, window.location.pathname);

        // Redirect or show logged-in UI after short delay
        setTimeout(() => {
          window.location.href = '/'; // or wherever you want to redirect
        }, 2500);
      } catch (e) {
        showMessage('Authentication failed: Unable to complete login', 'error');
        setTimeout(() => {
          window.location.href = '/';
        }, 4000);
      }
    }

    // Run on page load
    window.addEventListener('DOMContentLoaded', () => {
      handleCallback();
    });
  </script>
</body>
</html>
